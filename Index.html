<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Journal PWA (LocalStorage Fix)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Custom styles for PWA feel */
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Style for clickable boxes (buttons) - unselected state */
        .selection-box {
            background-color: #f9fafb; /* Lightest gray background */
            color: #4b5563; /* Dark gray text */
            border: 2px solid #e5e7eb; /* Light border */
            text-align: center;
        }
        /* Style for clickable boxes (buttons) - selected state (Indigo) */
        .selection-box.selected {
            background-color: #e0e7ff; /* Indigo-100 */
            color: #4f46e5; /* Indigo-700 */
            border-color: #4f46e5; /* Indigo-600 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .analysis-group {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        /* --- PDF EXPORT STYLES (CRITICAL) --- */
        #print-details-container {
            display: none; /* Hidden by default */
            page-break-after: always;
        }

        @media print {
            .no-print { display: none !important; }
            #print-details-container { 
                display: block !important; /* ONLY visible during print */
                margin: 0; 
                padding: 0;
            }
            body { 
                padding: 0; 
                margin: 0;
                background: white; 
            }
            .card { box-shadow: none; border: none; }
            
            /* Ensure details look good */
            .print-trade-card {
                border: 1px solid #ccc;
                padding: 15px;
                margin-bottom: 15px;
                border-radius: 8px;
                page-break-inside: avoid;
            }
            .print-analysis-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-top: 10px;
            }
            .print-analysis-item {
                border-bottom: 1px dashed #eee;
                padding-bottom: 5px;
            }
        }
    </style>
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJpY29ucyI6W3sic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyIsInNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvMTY1ZGEwLzAwMDAwMD90ZXh0PVQiLCJwdXJwb3NlcyI6ImFueSBtYXNrYWJsZSJ9XSwic2hvcnRfbmFtZSI6IlRyYWRlIEpvdXJuYWwiLCJuYW1lIjoiUGVyc29uYWwgVHJhZGUgSm91cm5hbCBQV0EiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInN0YXJ0X3VybCI6Ii4iLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzE2NWRhMCJ9">
</head>
<body class="bg-gray-50 min-h-screen pb-20">

    <!-- Removed the loading overlay as localStorage is synchronous -->

    <header class="p-4 bg-indigo-600 text-white shadow-lg no-print">
        <h1 class="text-2xl font-bold tracking-tight">Trade Journal (Local Data)</h1>
        <p id="user-info" class="text-sm opacity-80 mt-1">Data is stored securely on this device's **browser Local Storage** (5MB limit).</p>
    </header>

    <main class="container mx-auto p-4">
        
        <!-- --- PRINT-ONLY JOURNAL DETAILS CONTAINER --- -->
        <!-- This container is hidden during normal use but is populated and displayed during export -->
        <div id="print-details-container">
            <div class="p-6">
                <h1 class="text-2xl font-bold mb-4 border-b pb-2">Trade Journal Detailed Export</h1>
                <p class="mb-6 text-gray-600">Export Date: <span id="export-date"></span></p>
                <div id="print-summary-stats" class="grid grid-cols-4 gap-4 mb-8 text-center border p-3 rounded-lg bg-gray-50">
                    <!-- Summary stats for print will be populated here -->
                </div>
                <h2 class="text-xl font-bold mb-4">Detailed Trade Records</h2>
                <div id="printable-records">
                    <!-- Detailed trade cards are generated here -->
                </div>
            </div>
        </div>
        <!-- -------------------------------------------- -->


        <!-- Log New Trade Section -->
        <section class="mb-8 card bg-white p-5 rounded-xl no-print">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Log New Trade</h2>
            <form id="trade-form">

                <!-- --- SECTION: PRE-TRADE ANALYSIS --- -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4">Multi-Timeframe Analysis</h3>

                    <!-- Check News -->
                    <div class="analysis-group">
                        <label class="block text-base font-semibold text-gray-700 mb-2">Check News</label>
                        <div class="grid grid-cols-2 gap-3" id="analysis-news-group">
                            <button type="button" data-value="Yes" data-input="newsCheck" class="analysis-btn selection-box p-3 rounded-lg text-base font-medium transition duration-150">
                                Yes
                            </button>
                            <button type="button" data-value="No" data-input="newsCheck" class="analysis-btn selection-box p-3 rounded-lg text-base font-medium transition duration-150">
                                No
                            </button>
                        </div>
                        <input type="hidden" id="newsCheck" required>
                    </div>

                    <!-- Timeframe Analysis Groups -->
                    <div id="timeframe-analysis-container">
                        <!-- Content populated by JavaScript below -->
                    </div>

                    <!-- Hidden inputs for timeframes -->
                    <input type="hidden" id="weeklyChart" required>
                    <input type="hidden" id="dailyChart" required>
                    <input type="hidden" id="fourHourlyChart" required>
                    <input type="hidden" id="oneHourlyChart" required>
                    <input type="hidden" id="fifteenMinChart" required>
                    <input type="hidden" id="fiveMinChart" required>
                </div>


                <!-- --- SECTION: TRADE EXECUTION --- -->
                <div class="mb-6 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4">Transaction Details & Planning</h3>
                    
                    <!-- 1. TRADE ACTION (Clickable Boxes) -->
                    <label class="block text-sm font-medium text-gray-700 mb-2">Trade Action (BUY / SELL)</label>
                    <div class="grid grid-cols-2 gap-3 mb-4" id="trade-type-group">
                        <button type="button" data-value="BUY" class="trade-type-btn selection-box p-4 rounded-lg text-lg font-bold transition duration-150">
                            BUY
                        </button>
                        <button type="button" data-value="SELL" class="trade-type-btn selection-box p-4 rounded-lg text-lg font-bold transition duration-150">
                            SELL (Short)
                        </button>
                    </div>
                    <input type="hidden" id="trade-type" required>

                    <!-- Setup Category -->
                    <div class="mb-4">
                        <label for="setupCategory" class="block text-sm font-medium text-gray-700 mb-2">Setup Category/Strategy</label>
                        <div class="grid grid-cols-3 gap-3" id="setup-category-group">
                            <button type="button" data-value="Breakout" data-input="setupCategory" class="analysis-btn selection-box p-3 rounded-lg text-sm font-medium transition duration-150">Breakout</button>
                            <button type="button" data-value="Retest" data-input="setupCategory" class="analysis-btn selection-box p-3 rounded-lg text-sm font-medium transition duration-150">Retest</button>
                            <button type="button" data-value="Reversal" data-input="setupCategory" class="analysis-btn selection-box p-3 rounded-lg text-sm font-medium transition duration-150">Reversal</button>
                        </div>
                        <input type="hidden" id="setupCategory" required>
                    </div>

                    <!-- 2. BASIC INPUTS (Asset, Volume) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label for="asset" class="block text-sm font-medium text-gray-700">Asset/Symbol</label>
                            <input type="text" id="asset" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-4">
                            <label for="volume" class="block text-sm font-medium text-gray-700">Volume/Shares</label>
                            <input type="number" id="volume" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <!-- 3. PRICE INPUTS (Entry, Exit) -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="mb-4">
                            <label for="entry-price" class="block text-sm font-medium text-gray-700">Entry Price ($)</label>
                            <input type="number" step="0.01" id="entry-price" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-4">
                            <label for="exit-price" class="block text-sm font-medium text-gray-700">Exit Price ($) (Optional)</label>
                            <input type="number" step="0.01" id="exit-price" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <!-- R:R Ratio -->
                        <div class="mb-4">
                            <label for="riskReward" class="block text-sm font-medium text-gray-700">Planned R:R (e.g., 2.5)</label>
                            <input type="number" step="0.1" id="riskReward" required min="0.1" placeholder="e.g., 2.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- --- SECTION: TRADE OUTCOME & REFLECTION --- -->
                <div class="mb-6 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4">Outcome & Reflection</h3>

                    <!-- 4. TRADE RESULT (Clickable Boxes) -->
                    <label class="block text-sm font-medium text-gray-700 mb-2">P&L Result (Optional)</label>
                    <div class="grid grid-cols-3 gap-3 mb-6" id="trade-result-group">
                        <button type="button" data-value="WIN" class="trade-result-btn selection-box p-3 rounded-lg text-base font-medium transition duration-150">
                            <span class="text-xl">üöÄ</span> WIN
                        </button>
                        <button type="button" data-value="LOSS" class="trade-result-btn selection-box p-3 rounded-lg text-base font-medium transition duration-150">
                            <span class="text-xl">üîª</span> LOSS
                        </button>
                        <button type="button" data-value="BE" class="trade-result-btn selection-box p-3 rounded-lg text-base font-medium transition duration-150">
                            <span class="text-xl">‚è∏Ô∏è</span> B/E
                        </button>
                    </div>
                    <input type="hidden" id="trade-result">

                    <label for="notes" class="block text-sm font-medium text-gray-700">Notes & Lessons Learned</label>
                    <textarea id="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <button type="submit" id="log-trade-btn" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Save Trade Log (Local)
                </button>
            </form>
        </section>

        <!-- Summary & Action Buttons Section -->
        <section class="mb-8 card bg-white p-5 rounded-xl no-print">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Journal Summary</h2>

            <!-- Filter by Asset -->
            <div class="mb-4">
                <label for="filter-asset" class="block text-sm font-medium text-gray-700">Filter by Asset</label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="filter-asset" placeholder="e.g., EURUSD, TSLA" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="clear-filter-btn" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <div id="summary-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-5 text-center">
                <!-- Stats will be populated here -->
            </div>

            <button onclick="exportToPdf()" class="w-full md:w-auto py-2 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 flex items-center justify-center mx-auto">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m4 0v3m4-3v3m-3 0h2"></path></svg>
                Export COMPLETE Journal to PDF
            </button>
        </section>
        
        <!-- Trade Records Section (Summary Table) -->
        <section id="trade-list-section" class="card bg-white p-5 rounded-xl">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 no-print">Trade Records (Summary)</h2>
            
            <div id="trades-list" class="overflow-x-auto no-print">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset</th>
                            <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">R:R</th>
                            <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P/L ($)</th>
                            <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                            <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trade-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="7" class="p-4 text-center text-gray-500">Loading local data...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Detail Modal (Hidden by Default) -->
            <div id="detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 hidden items-center justify-center p-4 no-print" onclick="hideModal(event)">
                <div class="bg-white rounded-xl max-w-lg w-full p-6 card" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-indigo-600">Trade Details</h3>
                    <div id="modal-content" class="space-y-3 text-gray-700 max-h-[70vh] overflow-y-auto pr-2">
                        <!-- Details will be injected here -->
                    </div>
                    <button onclick="document.getElementById('detail-modal').classList.add('hidden')" class="mt-6 w-full py-2 px-4 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700">Close</button>
                </div>
            </div>

            <!-- Custom Alert/Modal (for status messages) -->
            <div id="custom-alert" class="fixed bottom-4 right-4 z-50 p-4 rounded-lg text-white shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none"></div>

        </section>

    </main>

    <script type="module">
        let tradesData = []; // Cache for current trades
        const LOCAL_STORAGE_KEY = 'TradeJournal_v1';
        let currentFilteredTrades = []; // Store trades currently shown/exported

        const tradeForm = document.getElementById('trade-form');
        const logTradeBtn = document.getElementById('log-trade-btn');
        const tableBody = document.getElementById('trade-table-body');
        const summaryStats = document.getElementById('summary-stats');
        const filterInput = document.getElementById('filter-asset');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const printDetailsContainer = document.getElementById('print-details-container');
        const printableRecords = document.getElementById('printable-records');
        const printSummaryStats = document.getElementById('print-summary-stats');

        // --- PWA Service Worker Registration (for Installability) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `self.addEventListener('fetch', (event) => {});`;
                const swBlob = new Blob([swCode], { type: 'text/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swUrl).catch(err => console.error("SW registration failed:", err));
            });
        }
        // -----------------------------------------------------------

        // --- LocalStorage Helper Functions (Synchronous) ---

        /** Gets all trades from localStorage */
        function getAllTrades() {
            try {
                const rawData = localStorage.getItem(LOCAL_STORAGE_KEY);
                return rawData ? JSON.parse(rawData) : [];
            } catch (e) {
                console.error("Error reading from localStorage:", e);
                showAlert("Error loading data from local storage. Data might be corrupted.", 'error');
                return [];
            }
        }

        /** Saves the entire trade array to localStorage */
        function saveAllTrades(trades) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(trades));
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                // Check for QuotaExceededError (5MB limit hit)
                if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                     showAlert("Local Storage limit reached (usually 5MB). Cannot save more trades.", 'error');
                } else {
                    showAlert("Error saving data to local storage.", 'error');
                }
            }
        }
        
        /** Refreshes the trade data and re-renders the UI */
        function refreshTrades() {
            try {
                const trades = getAllTrades();
                // Ensure trades are properly formatted (simulating firestore date object)
                tradesData = trades.map(t => ({
                    ...t,
                    createdAt: { 
                        toDate: () => new Date(t.createdAt),
                        seconds: Math.floor(t.createdAt / 1000)
                    }
                })).sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
                
                applyFilters();
            } catch (error) {
                console.error("Failed to refresh trades:", error);
                showAlert(`Failed to load data: ${error.message}`, 'error');
            }
        }
        
        // --- Utility Functions ---

        /** Generates a simple unique ID */
        function generateUniqueId() {
            return 'trade-' + Date.now() + Math.random().toString(36).substring(2, 9);
        }

        /** Shows a temporary alert message */
        function showAlert(message, type = 'success') {
            const alertEl = document.getElementById('custom-alert');
            alertEl.textContent = message;
            alertEl.className = `fixed bottom-4 right-4 z-50 p-4 rounded-lg text-white shadow-lg transition-opacity duration-300`;
            
            if (type === 'success') {
                alertEl.classList.add('bg-green-500');
            } else if (type === 'error') {
                alertEl.classList.add('bg-red-500');
            } else {
                alertEl.classList.add('bg-blue-500');
            }
            
            alertEl.classList.remove('opacity-0', 'pointer-events-none');
            
            setTimeout(() => {
                alertEl.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }

        /** Calculates P&L */
        function calculatePNL(type, entry, exit, volume) {
            const diff = exit - entry;
            let pnl = 0;
            if (type === 'BUY') {
                pnl = diff * volume;
            } else if (type === 'SELL') {
                pnl = -diff * volume; // PNL is inverse for short trades
            }
            return parseFloat(pnl.toFixed(2));
        }

        /** Formats P&L for display */
        function formatPNL(pnl) {
            const sign = pnl >= 0 ? '+' : '';
            const color = pnl > 0 ? 'text-green-600 font-bold' : pnl < 0 ? 'text-red-600 font-bold' : 'text-gray-500';
            return `<span class="${color}">${sign}${pnl.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</span>`;
        }
        
        // --- Analysis Labels Mapping ---
        const analysisLabels = {
            newsCheck: 'Check News',
            weeklyChart: 'Weekly Chart',
            dailyChart: 'Daily Chart',
            fourHourlyChart: '4 Hourly Chart',
            oneHourlyChart: '1 Hourly Chart',
            fifteenMinChart: '15 Min Chart',
            fiveMinChart: '5 Min Chart',
        };
        const analysisKeys = Object.keys(analysisLabels);


        /** Renders a single trade row for the summary table (UI) */
        function renderTradeRow(trade) {
            let pnlHtml = '<span class="text-gray-500">N/A</span>';
            if (trade.exitPrice !== null && trade.result !== 'OPEN') {
                const pnl = calculatePNL(trade.type, trade.entryPrice, trade.exitPrice, trade.volume);
                pnlHtml = formatPNL(pnl);
            }
            
            const statusColor = trade.result === 'WIN' ? 'bg-green-100 text-green-800' :
                                trade.result === 'LOSS' ? 'bg-red-100 text-red-800' :
                                trade.result === 'BE' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-gray-100 text-gray-800';
            
            const date = trade.createdAt ? trade.createdAt.toDate().toLocaleDateString() : 'N/A';
            const actionButton = `<button onclick="showTradeDetails('${trade.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">${trade.result === 'OPEN' ? 'Close/View' : 'View'}</button>`;

            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${date}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${trade.asset}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${trade.type === 'BUY' ? 'bg-green-200 text-green-900' : 'bg-red-200 text-red-900'}">
                            ${trade.type}
                        </span>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center">
                        ${trade.riskReward ? `1:${trade.riskReward}` : 'N/A'}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center">
                        ${pnlHtml}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                            ${trade.result}
                        </span>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium no-print">
                        ${actionButton}
                        <button onclick="deleteTrade('${trade.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `;
        }

        /** Renders all trades and summary stats based on the provided trades array */
        function renderTrades(trades) {
            currentFilteredTrades = trades; // Update the cache for exporting
            
            const closedTrades = trades.filter(t => t.result !== 'OPEN' && t.exitPrice !== null);
            let totalPNL = 0;
            let totalTrades = trades.length;
            let wins = 0;
            let losses = 0;
            let breakEvens = 0;

            const tableHtml = trades.map(trade => renderTradeRow(trade)).join('');
            
            closedTrades.forEach(trade => {
                const pnl = calculatePNL(trade.type, trade.entryPrice, trade.exitPrice, trade.volume);
                totalPNL += pnl;
                if (trade.result === 'WIN') wins++;
                if (trade.result === 'LOSS') losses++;
                if (trade.result === 'BE') breakEvens++;
            });

            tableBody.innerHTML = tableHtml.length > 0 ? tableHtml : '<tr><td colspan="7" class="p-4 text-center text-gray-500">No trades logged yet.</td></tr>';

            // Function to render the stats block (used for both UI and Print)
            const renderStats = (container) => {
                const winRate = closedTrades.length > 0 ? ((wins / closedTrades.length) * 100).toFixed(1) : 0;
                container.innerHTML = `
                    <div class="p-2 rounded-lg bg-indigo-50">
                        <p class="text-xl font-bold text-indigo-700">${totalTrades}</p>
                        <p class="text-xs text-gray-500">Total Trades</p>
                    </div>
                    <div class="p-2 rounded-lg bg-green-50">
                        <p class="text-xl font-bold text-green-700">${wins}</p>
                        <p class="text-xs text-gray-500">Wins (${winRate}%)</p>
                    </div>
                    <div class="p-2 rounded-lg bg-red-50">
                        <p class="text-xl font-bold text-red-700">${losses}</p>
                        <p class="text-xs text-gray-500">Losses</p>
                    </div>
                    <div class="p-2 rounded-lg bg-gray-100">
                        <p class="text-xl font-bold ${totalPNL >= 0 ? 'text-green-600' : 'text-red-600'}">${formatPNL(totalPNL).replace(/<\/?span[^>]*>/g, "")}</p>
                        <p class="text-xs text-gray-500">Net P&L (Closed)</p>
                    </div>
                `;
            }

            renderStats(summaryStats); // Render UI stats
            renderStats(printSummaryStats); // Render print stats
        }
        
        // --- Modal/Detail Functions ---

        window.showTradeDetails = (tradeId) => {
            const trade = tradesData.find(t => t.id === tradeId);
            if (!trade) return;

            const date = trade.createdAt ? trade.createdAt.toDate().toLocaleString() : 'N/A';
            
            let pnlHtml = '<span class="font-bold">N/A (Trade Open)</span>';
            let resultHtml = `<span class="px-2 py-1 rounded-lg text-white bg-gray-500 font-semibold">${trade.result}</span>`;

            if (trade.exitPrice !== null && trade.result !== 'OPEN') {
                const pnl = calculatePNL(trade.type, trade.entryPrice, trade.exitPrice, trade.volume);
                pnlHtml = formatPNL(pnl);
                const statusColor = trade.result === 'WIN' ? 'bg-green-500' : trade.result === 'LOSS' ? 'bg-red-500' : 'bg-yellow-500';
                resultHtml = `<span class="px-2 py-1 rounded-lg text-white ${statusColor} font-semibold">${trade.result}</span>`;
            }
            
            // Generate Analysis Summary for Modal
            const analysisHtml = analysisKeys.map(key => `
                <p><strong>${analysisLabels[key]}:</strong> <span class="font-medium">${trade[key] || 'N/A'}</span></p>
            `).join('');
            
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <p><strong>Date Logged:</strong> ${date}</p>
                <p><strong>Asset:</strong> <span class="font-bold text-indigo-600">${trade.asset}</span></p>
                <p><strong>Type:</strong> <span class="font-bold text-${trade.type === 'BUY' ? 'green' : 'red'}-600">${trade.type}</span></p>
                <p><strong>Setup Category:</strong> <span class="font-bold text-indigo-600">${trade.setupCategory || 'N/A'}</span></p>
                <p><strong>Planned R:R:</strong> <span class="font-bold text-indigo-600">1:${trade.riskReward || 'N/A'}</span></p>
                <hr class="my-3"/>
                <h4 class="text-lg font-bold text-gray-800">Pre-Trade Analysis</h4>
                <div class="bg-gray-50 p-3 rounded-lg space-y-1">
                    ${analysisHtml}
                </div>
                <hr class="my-3"/>
                <p><strong>Entry Price:</strong> $${trade.entryPrice}</p>
                <p><strong>Exit Price:</strong> $${trade.exitPrice !== null ? trade.exitPrice : 'N/A'}</p>
                <p><strong>Volume:</strong> ${trade.volume}</p>
                <p><strong>Result:</strong> ${resultHtml}</p>
                <p><strong>Total P&L:</strong> ${pnlHtml}</p>
                <hr class="my-3"/>
                <p><strong>Notes:</strong></p>
                <p class="whitespace-pre-wrap bg-gray-100 p-3 rounded-lg">${trade.notes || 'No notes provided.'}</p>
            `;

            // --- Add Update Form if Trade is OPEN ---
            if (trade.result === 'OPEN' || trade.exitPrice === null) {
                modalContent.innerHTML += `
                    <hr class="my-4 border-t-2 border-indigo-200"/>
                    <h4 class="text-lg font-bold text-indigo-700">Close Trade</h4>
                    <div class="space-y-3 mt-2">
                        <div>
                            <label for="modal-exit-price" class="block text-sm font-medium text-gray-700">Exit Price ($)</label>
                            <input type="number" step="0.01" id="modal-exit-price" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">P&L Result</label>
                            <div class="grid grid-cols-3 gap-3" id="modal-trade-result-group">
                                <button type="button" data-value="WIN" class="selection-box p-3 rounded-lg text-base font-medium transition duration-150"><span class="text-xl">üöÄ</span> WIN</button>
                                <button type="button" data-value="LOSS" class="selection-box p-3 rounded-lg text-base font-medium transition duration-150"><span class="text-xl">üîª</span> LOSS</button>
                                <button type="button" data-value="BE" class="selection-box p-3 rounded-lg text-base font-medium transition duration-150"><span class="text-xl">‚è∏Ô∏è</span> B/E</button>
                            </div>
                            <input type="hidden" id="modal-trade-result" required>
                        </div>
                        <button type="button" id="modal-save-btn" onclick="handleUpdateTrade('${trade.id}')" class="mt-4 w-full py-2 px-4 rounded-lg text-white bg-green-600 hover:bg-green-700">
                            Save Update
                        </button>
                    </div>
                `;

                // Add event listener for the newly injected modal buttons
                document.getElementById('modal-trade-result-group').addEventListener('click', (e) => {
                    const btn = e.target.closest('.selection-box');
                    if (btn) {
                        document.getElementById('modal-trade-result-group').querySelectorAll('.selection-box').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        document.getElementById('modal-trade-result').value = btn.dataset.value;
                    }
                });
            }

            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-modal').classList.add('flex');
        };

        window.hideModal = (event) => {
            if (event.target.id === 'detail-modal') {
                document.getElementById('detail-modal').classList.add('hidden');
            }
        };

        // --- Data Manipulation Logic ---

        /** Handles form submission and saving data to localStorage */
        async function handleLogTrade(event) {
            event.preventDefault();

            // Get standard fields
            const type = document.getElementById('trade-type').value;
            const result = document.getElementById('trade-result').value; 
            const setupCategory = document.getElementById('setupCategory').value;
            const asset = document.getElementById('asset').value.toUpperCase().trim();
            const volume = parseFloat(document.getElementById('volume').value);
            const entryPrice = parseFloat(document.getElementById('entry-price').value);
            const exitPrice = parseFloat(document.getElementById('exit-price').value); 
            const riskReward = parseFloat(document.getElementById('riskReward').value);
            const notes = document.getElementById('notes').value.trim();
            
            // Get all analysis fields
            const analysisData = analysisKeys.reduce((acc, key) => {
                acc[key] = document.getElementById(key).value;
                return acc;
            }, {});

            // Basic validation check
            if (!type || !setupCategory || !asset || isNaN(volume) || isNaN(entryPrice) || isNaN(riskReward) || volume <= 0 || riskReward <= 0) {
                showAlert('Please fill all required fields (Type, Setup, Asset, Volume, Entry, R:R).', 'error');
                return;
            }

            // Analysis validation (check if all analysis fields have been selected)
            const missingAnalysis = analysisKeys.filter(key => !analysisData[key]);
            if (missingAnalysis.length > 0) {
                 showAlert('Please complete all Multi-Timeframe Analysis selections.', 'error');
                 return;
            }


            logTradeBtn.disabled = true;
            logTradeBtn.innerHTML = '<svg class="animate-spin w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving...';

            try {
                const newTrade = {
                    id: generateUniqueId(),
                    asset,
                    type,
                    result: result || (isNaN(exitPrice) ? 'OPEN' : result), // Use result or default to OPEN/CLOSED
                    setupCategory,
                    riskReward,
                    volume,
                    entryPrice,
                    exitPrice: isNaN(exitPrice) ? null : exitPrice, // Save null if empty
                    notes,
                    ...analysisData, 
                    createdAt: Date.now() // Timestamp in milliseconds
                };
                
                // 1. Get current trades
                const currentTrades = getAllTrades();
                // 2. Add the new trade
                currentTrades.push(newTrade);
                // 3. Save the full list
                saveAllTrades(currentTrades);

                refreshTrades(); // Refresh UI after saving

                showAlert('Trade successfully logged to local storage!', 'success');
                tradeForm.reset();
                // Deselect all buttons and clear hidden input values
                document.querySelectorAll('.selection-box').forEach(btn => btn.classList.remove('selected'));
                document.querySelectorAll('input[type="hidden"]').forEach(input => input.value = '');


            } catch (e) {
                console.error("Error logging trade: ", e);
                showAlert(`Error logging trade: ${e.message}`, 'error');
            } finally {
                logTradeBtn.disabled = false;
                logTradeBtn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Save Trade Log (Local)';
            }
        }

        /** Handles updating an existing trade (closing it) */
        window.handleUpdateTrade = async (tradeId) => {
            const tradeIndex = tradesData.findIndex(t => t.id === tradeId);
            if (tradeIndex === -1) return;

            const exitPrice = parseFloat(document.getElementById('modal-exit-price').value);
            const result = document.getElementById('modal-trade-result').value;

            if (isNaN(exitPrice) || !result) {
                showAlert('Please enter a valid Exit Price and select a P&L Result.', 'error');
                return;
            }

            const btn = document.getElementById('modal-save-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                // Get raw trades from storage
                const rawTrades = getAllTrades();
                const rawTradeIndex = rawTrades.findIndex(t => t.id === tradeId);
                
                if (rawTradeIndex === -1) throw new Error("Trade not found in storage.");
                
                // Update the raw trade object
                rawTrades[rawTradeIndex].exitPrice = exitPrice;
                rawTrades[rawTradeIndex].result = result;
                
                saveAllTrades(rawTrades);
                refreshTrades(); // Refresh UI after updating

                showAlert('Trade successfully updated in local storage!', 'success');
                document.getElementById('detail-modal').classList.add('hidden');

            } catch (error) {
                console.error("Error updating trade: ", error);
                showAlert(`Error updating trade: ${error.message}`, 'error');
            } finally {
                 btn.disabled = false;
                 btn.textContent = 'Save Update';
            }
        }
        
        window.deleteTrade = async (tradeId) => {
            const confirmed = confirm("Are you sure you want to delete this trade record? This action cannot be undone.");
            if (!confirmed) return;

            try {
                // Get raw trades from storage
                let rawTrades = getAllTrades();
                // Filter out the trade to delete
                rawTrades = rawTrades.filter(t => t.id !== tradeId);
                // Save the filtered list
                saveAllTrades(rawTrades);
                
                refreshTrades(); // Refresh UI after deleting
                showAlert('Trade record deleted from local storage.', 'success');
            } catch (error)
                {
                console.error("Error deleting trade: ", error);
                showAlert(`Error deleting trade: ${error.message}`, 'error');
            }
        }

        // --- Filter and Export Logic ---

        function applyFilters() {
            const filterValue = filterInput.value.toUpperCase().trim();
            if (!filterValue) {
                renderTrades(tradesData); // Render all
            } else {
                const filteredTrades = tradesData.filter(t => 
                    t.asset.toUpperCase().includes(filterValue)
                );
                renderTrades(filteredTrades); // Render filtered
            }
        }
        
        /** Generates the detailed HTML content for the PDF export */
        function generatePrintableDetails(trades) {
            let html = '';
            
            trades.forEach(trade => {
                const date = trade.createdAt ? trade.createdAt.toDate().toLocaleString() : 'N/A';
                const pnl = trade.exitPrice !== null && trade.result !== 'OPEN' 
                            ? calculatePNL(trade.type, trade.entryPrice, trade.exitPrice, trade.volume) 
                            : 'N/A (Trade Open)';
                const pnlDisplay = pnl !== 'N/A (Trade Open)' ? formatPNL(pnl).replace(/<\/?span[^>]*>/g, "") : pnl;
                const pnlColor = pnl > 0 ? 'text-green-700' : pnl < 0 ? 'text-red-700' : 'text-gray-700';
                
                const analysisHtml = analysisKeys.map(key => `
                    <div class="print-analysis-item">
                        <strong>${analysisLabels[key]}:</strong> ${trade[key] || 'N/A'}
                    </div>
                `).join('');

                html += `
                    <div class="print-trade-card">
                        <h3 class="text-lg font-bold mb-3 border-b pb-1 text-indigo-700">
                            ${trade.asset} - ${trade.type} (${trade.result})
                        </h3>
                        
                        <div class="grid grid-cols-2 gap-y-1 mb-4 text-sm">
                            <p><strong>Date Logged:</strong> ${date}</p>
                            <p><strong>R:R:</strong> 1:${trade.riskReward || 'N/A'}</p>
                            <p><strong>Category:</strong> ${trade.setupCategory || 'N/A'}</p>
                            <p><strong>Volume:</strong> ${trade.volume}</p>
                        </div>

                        <h4 class="font-semibold text-gray-800 mt-2 mb-1">Price & Outcome</h4>
                        <div class="grid grid-cols-3 mb-4 text-sm">
                            <p><strong>Entry:</strong> $${trade.entryPrice}</p>
                            <p><strong>Exit:</strong> ${trade.exitPrice !== null ? '$' + trade.exitPrice : 'OPEN'}</p>
                            <p><strong>P&L:</strong> <span class="${pnlColor} font-bold">${pnlDisplay}</span></p>
                        </div>
                        
                        <h4 class="font-semibold text-gray-800 mt-2">Multi-Timeframe Analysis</h4>
                        <div class="print-analysis-grid">
                            ${analysisHtml}
                        </div>
                        
                        <h4 class="font-semibold text-gray-800 mt-3 mb-1">Notes & Lessons</h4>
                        <p class="whitespace-pre-wrap text-sm border p-2 bg-gray-50 rounded">${trade.notes || 'No notes provided.'}</p>
                    </div>
                `;
            });

            printableRecords.innerHTML = html.length > 0 ? html : '<p class="text-center text-lg text-red-600">No trades found in the current filter for export.</p>';
            document.getElementById('export-date').textContent = new Date().toLocaleDateString();
        }

        window.exportToPdf = () => {
            // Use all trades data directly for the COMPLETE journal export
            const tradesToExport = tradesData; 

            if (tradesToExport.length === 0) {
                 showAlert('Cannot export: No trades have been logged in the journal yet.', 'error');
                 return;
            }

            // 1. Generate the detailed, print-only content using ALL trades
            generatePrintableDetails(tradesToExport);

            // 2. Trigger the browser print window
            showAlert('Generating COMPLETE PDF preview...', 'info');
            window.print();
            
            // Clean up the generated HTML content after a short delay
            setTimeout(() => {
                printableRecords.innerHTML = ''; 
            }, 1000);
        };

        // --- Initialization ---

        const timeframes = [
            { label: "Weekly Chart", id: "weeklyChart" },
            { label: "Daily Chart", id: "dailyChart" },
            { label: "4 Hourly Chart", id: "fourHourlyChart" },
            { label: "1 Hourly Chart", id: "oneHourlyChart" },
            { label: "15 Min Chart", id: "fifteenMinChart" },
            { label: "5 Min Chart", id: "fiveMinChart" },
        ];

        const tfContainer = document.getElementById('timeframe-analysis-container');

        // Dynamically generate the analysis groups
        timeframes.forEach(tf => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'analysis-group';
            groupDiv.id = `group-${tf.id}`;
            groupDiv.innerHTML = `
                <label class="block text-base font-semibold text-gray-700 mb-2">${tf.label}</label>
                <div class="grid grid-cols-3 gap-3">
                    <button type="button" data-value="Bullish" data-input="${tf.id}" class="analysis-btn selection-box p-3 rounded-lg text-sm font-medium transition duration-150">
                        Bullish
                    </button>
                    <button type="button" data-value="Bearish" data-input="${tf.id}" class="analysis-btn selection-box p-3 rounded-lg text-sm font-medium transition duration-150">
                        Bearish
                    </button>
                    <button type="button" data-value="Neutral" data-input="${tf.id}" class="analysis-btn selection-box p-3 rounded-lg text-sm font-medium transition duration-150">
                        Neutral
                    </button>
                </div>
            `;
            tfContainer.appendChild(groupDiv);
        });


        // Global listener for all analysis and category buttons
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.analysis-btn');
            if (btn) {
                const inputId = btn.dataset.input;
                const parentDiv = btn.parentElement;
                
                // Deselect all siblings within the same parent container
                parentDiv.querySelectorAll('.analysis-btn').forEach(b => b.classList.remove('selected'));
                
                // Select clicked button and update hidden input
                btn.classList.add('selected');
                document.getElementById(inputId).value = btn.dataset.value;
            }
        });

        // Setup for Trade Action and P&L Result groups
        function setupSelectionGroup(groupId, inputId) {
            document.getElementById(groupId).addEventListener('click', (e) => {
                const btn = e.target.closest('.selection-box');
                if (btn) {
                    document.getElementById(groupId).querySelectorAll('.selection-box').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.getElementById(inputId).value = btn.dataset.value;
                }
            });
        }

        setupSelectionGroup('trade-type-group', 'trade-type');
        setupSelectionGroup('trade-result-group', 'trade-result');

        tradeForm.addEventListener('submit', handleLogTrade);

        // Filter Listeners
        filterInput.addEventListener('input', applyFilters);
        clearFilterBtn.addEventListener('click', () => {
            filterInput.value = '';
            applyFilters();
        });

        // Initial data load
        refreshTrades();

    </script>
</body>
</html>

